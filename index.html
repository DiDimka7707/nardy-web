<!doctype html>
<html lang="ru">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover"/>
<title>–ù–∞—Ä–¥—ã –ö–ª–∞—Å—Å–∏–∫–∞ ¬∑ v24</title>
<meta name="color-scheme" content="dark light"/>
<style>
  :root{--bg:#0e1116;--card:#171b22;--muted:#8b95a7;--text:#e8eefc;--border:rgba(255,255,255,.08);
        --primary:#4da3ff;--primary2:#6a7bff;--ring:0 0 0 2px rgba(77,163,255,.35),0 8px 20px rgba(77,163,255,.25);--radius:16px;}
  *{box-sizing:border-box} html,body{height:100%}
  body{margin:0;background:radial-gradient(1000px 600px at 50% -120px,#1b2230 0%,var(--bg) 60%);
       color:var(--text);font:16px/1.45 system-ui,-apple-system,Segoe UI,Roboto,Inter,Arial,sans-serif;-webkit-tap-highlight-color:transparent;}
  .app{min-height:100dvh;padding-bottom:96px}
  header{position:sticky;top:0;z-index:10;display:flex;justify-content:space-between;align-items:center;
         padding:14px 16px calc(14px + env(safe-area-inset-top));
         background:linear-gradient(180deg,rgba(10,12,18,.85),rgba(10,12,18,0));backdrop-filter:blur(10px)}
  .title{font-weight:800;font-size:20px}
  .balance{display:flex;gap:8px;align-items:center;background:linear-gradient(135deg,rgba(77,163,255,.2),rgba(106,123,255,.2));
           border:1px solid var(--border);padding:8px 12px;border-radius:999px}
  .coin{width:20px;height:20px;border-radius:50%;background:radial-gradient(circle at 30% 30%,#fff2a1,#ffd05a 40%,#ffb800 70%,#ef9f00 100%);
        box-shadow:0 1px 0 #fff8, inset 0 0 4px #0006}
  main{padding:12px 14px 24px}
  .card{background:linear-gradient(180deg,rgba(255,255,255,.03),rgba(255,255,255,.01)); border:1px solid var(--border);
        border-radius:var(--radius); padding:18px; box-shadow:0 10px 40px rgba(0,0,0,.25)}
  h2{margin:0 0 8px;font-size:26px} p.muted{color:var(--muted);margin:0 0 10px;font-size:14px}
  .btn{width:100%;padding:14px 16px;border-radius:14px;border:none;color:#fff;font-weight:800;font-size:16px;cursor:pointer;user-select:none}
  .btn.primary{background:linear-gradient(135deg,var(--primary),var(--primary2));box-shadow:var(--ring)}
  .btn.secondary{background:linear-gradient(135deg,#2a3140,#222a36);color:#dbe7ff;border:1px solid var(--border)}
  .btn.ghost{background:transparent;color:#c9d6ff;border:1px dashed rgba(255,255,255,.25)}
  .btn:disabled{opacity:.6} .spacer{height:12px} .space{height:16px}
  .row{display:flex;gap:12px} .col{flex:1}
  .screen{display:none} .screen.active{display:block}
  nav.tabbar{position:fixed;left:0;right:0;bottom:0;z-index:20;display:flex;gap:10px;justify-content:space-between;
             padding:10px 10px calc(10px + env(safe-area-inset-bottom));
             background:linear-gradient(180deg,rgba(10,12,18,0),rgba(10,12,18,.85) 30%,rgba(10,12,18,.95));
             backdrop-filter:blur(12px); border-top:1px solid var(--border)}
  .tab{flex:1;padding:10px 8px;border-radius:14px;border:1px solid var(--border);
       background:linear-gradient(180deg,rgba(255,255,255,.03),rgba(255,255,255,.01));
       color:#c9d6ff;font-weight:800;font-size:14px;display:flex;gap:8px;align-items:center;justify-content:center}
  .tab.active{color:#fff;box-shadow:var(--ring);outline:1px solid rgba(77,163,255,.45)}
  /* sheet */
  .sheet{position:fixed;inset:0;z-index:40;display:none}
  .sheet.open{display:block}
  .sheet .backdrop{position:absolute;inset:0;background:#0009;backdrop-filter:blur(2px)}
  .sheet .panel{position:absolute;left:0;right:0;bottom:0;border-radius:24px 24px 0 0;background:linear-gradient(180deg,#141923,#0f151f);
                border:1px solid rgba(255,255,255,.08);padding:16px 14px calc(18px + env(safe-area-inset-bottom));
                box-shadow:0 -20px 60px rgba(0,0,0,.45);animation:slideUp .22s ease both}
  @keyframes slideUp{from{transform:translateY(30px);opacity:0}to{transform:translateY(0);opacity:1}}
  .sheet .handle{width:44px;height:5px;border-radius:6px;background:#394150;margin:0 auto 12px}
  .input{width:100%;padding:14px;border-radius:12px;background:#0d131c;color:#eaf1ff;border:1px solid #243046;font-size:16px}
  .input::placeholder{color:#789}
  /* game canvas */
  #gameCanvas{width:100%;height:360px;display:block;border-radius:14px;border:1px solid var(--border);background:#0b0f16}
</style>
</head>
<body>
<div class="app">
  <header>
    <div class="title">–ù–∞—Ä–¥—ã –ö–ª–∞—Å—Å–∏–∫–∞</div>
    <div class="balance"><div class="coin"></div><strong id="balance">0</strong></div>
  </header>

  <main>
    <!-- HOME -->
    <section id="screen-home" class="screen active">
      <div class="card">
        <h2>–ò–≥—Ä—ã</h2>
        <p class="muted">–°–æ–∑–¥–∞–π –∫–æ–º–Ω–∞—Ç—É, –ø—Ä–∏—Å–æ–µ–¥–∏–Ω–∏—Å—å –ø–æ –∫–æ–¥—É –∏–ª–∏ –≤–æ—Å–ø–æ–ª—å–∑—É–π—Å—è –±—ã—Å—Ç—Ä—ã–º –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ–º.</p>
        <div class="spacer"></div>
        <button id="btn-create" class="btn primary" onclick="onCreate()">üé≤ –°–æ–∑–¥–∞—Ç—å –∫–æ–º–Ω–∞—Ç—É</button>
        <div class="spacer"></div>
        <button id="btn-join" class="btn secondary" onclick="openJoin()">üîó –ü—Ä–∏—Å–æ–µ–¥–∏–Ω–∏—Ç—å—Å—è –ø–æ –∫–æ–¥—É</button>
        <div class="spacer"></div>
        <button id="btn-quick" class="btn secondary" onclick="onQuick()">‚ö° –ë—ã—Å—Ç—Ä–æ–µ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ</button>
      </div>
    </section>

    <!-- LOBBY -->
    <section id="screen-lobby" class="screen">
      <div class="card">
        <h2>–õ–æ–±–±–∏</h2>
        <p class="muted">–ö–æ–¥ –∫–æ–º–Ω–∞—Ç—ã: <strong id="roomCode">‚Äî</strong></p>
        <div class="space"></div>
        <div id="playersBox" class="row"></div>
        <div class="space"></div>
        <div class="row">
          <button id="btn-ready" class="btn secondary" onclick="toggleReady()">‚úÖ –Ø –≥–æ—Ç–æ–≤</button>
          <button id="btn-start" class="btn primary" onclick="onStart()" disabled>üö¶ –ù–∞—á–∞—Ç—å –º–∞—Ç—á</button>
        </div>
        <div class="spacer"></div>
        <button class="btn ghost" onclick="showScreen('home')">‚Üê –í–µ—Ä–Ω—É—Ç—å—Å—è</button>
      </div>
    </section>

    <!-- GAME -->
    <section id="screen-game" class="screen">
      <div class="card">
        <h2>–ú–∞—Ç—á</h2>
        <p class="muted">–•–æ–¥: <strong id="turnLabel">‚Äî</strong></p>
        <canvas id="gameCanvas" width="800" height="360"></canvas>
        <div class="space"></div>
        <div class="row">
          <button id="btn-roll" class="btn primary" onclick="onRoll()">üé≤ –ë—Ä–æ—Å–∏—Ç—å –∫—É–±–∏–∫–∏</button>
        </div>
        <div class="spacer"></div>
        <button class="btn ghost" onclick="showScreen('lobby')">‚Üê –í –ª–æ–±–±–∏</button>
      </div>
    </section>

    <!-- PROFILE -->
    <section id="screen-profile" class="screen">
      <div class="card">
        <h2>–ü—Ä–æ—Ñ–∏–ª—å</h2>
        <div class="space"></div>
        <input id="profileName" class="input" placeholder="–ò–º—è"/>
        <div class="spacer"></div>
        <input id="profileNick" class="input" placeholder="–ù–∏–∫–Ω–µ–π–º"/>
        <div class="space"></div>
        <button id="btn-save" class="btn primary" onclick="alert('–ü—Ä–æ—Ñ–∏–ª—å —Å–æ—Ö—Ä–∞–Ω—ë–Ω')">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
      </div>
    </section>

    <!-- THEMES -->
    <section id="screen-themes" class="screen">
      <div class="card">
        <h2>–û—Ñ–æ—Ä–º–ª–µ–Ω–∏—è</h2>
        <p class="muted">–°–∫–∏–Ω—ã –¥–æ—Å–∫–∏ –∏ –∫–æ—Å—Ç–µ–π ‚Äî —Å–∫–æ—Ä–æ.</p>
        <button class="btn ghost" disabled>–í —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–µ</button>
      </div>
    </section>

    <!-- DONATE -->
    <section id="screen-donate" class="screen">
      <div class="card">
        <h2>–î–æ–Ω–∞—Ç</h2>
        <p class="muted">–ú–≥–Ω–æ–≤–µ–Ω–Ω–æ–µ –∑–∞—á–∏—Å–ª–µ–Ω–∏–µ –º–æ–Ω–µ—Ç (–¥–µ–º–æ):</p>
        <div class="space"></div>
        <div class="row" id="donateGrid" style="flex-wrap:wrap; gap:10px"></div>
      </div>
    </section>
  </main>

  <nav class="tabbar">
    <button class="tab active" data-tab="home"    onclick="showScreen('home')">üéÆ –ò–≥—Ä—ã</button>
    <button class="tab"        data-tab="profile" onclick="showScreen('profile')">üë§ –ü—Ä–æ—Ñ–∏–ª—å</button>
    <button class="tab"        data-tab="themes"  onclick="showScreen('themes')">üé® –û—Ñ–æ—Ä–º–ª–µ–Ω–∏—è</button>
    <button class="tab"        data-tab="donate"  onclick="showScreen('donate')">üíé –î–æ–Ω–∞—Ç</button>
  </nav>
</div>

<!-- JOIN SHEET -->
<div id="join-sheet" class="sheet" aria-hidden="true">
  <div class="backdrop" onclick="closeJoin()"></div>
  <div class="panel">
    <div class="handle"></div>
    <h2 style="margin:0 0 8px">–ü—Ä–∏—Å–æ–µ–¥–∏–Ω–∏—Ç—å—Å—è</h2>
    <div class="space"></div>
    <div class="card" style="padding:14px">
      <h3 style="margin:0 0 8px;font-size:18px">–ü–æ –∫–æ–¥—É –∫–æ–º–Ω–∞—Ç—ã</h3>
      <input id="joinCodeInput" class="input" placeholder="–ù–∞–ø—Ä–∏–º–µ—Ä, 7B7FX" maxlength="8"/>
      <div class="spacer"></div>
      <button id="btn-join-go" class="btn primary" onclick="onJoinGo()">–í–æ–π—Ç–∏</button>
    </div>
    <div class="space"></div>
    <button class="btn ghost" onclick="closeJoin()">–ó–∞–∫—Ä—ã—Ç—å</button>
  </div>
</div>

<script>
/*** –í–ü–ò–®–ò –°–í–û–ô –î–û–ú–ï–ù KOYEB ***/
const API_BASE = 'https://<–¢–í–û–ô-–î–û–ú–ï–ù>.koyeb.app'; // <= –∑–∞–º–µ–Ω–∏ –Ω–∞ —Ç–≤–æ–π Public URL
const TG = window.Telegram?.WebApp; try{ TG?.expand?.() }catch{}

// ===== –£—Ç–∏–ª–∏—Ç—ã =====
function pop(m){ try{ TG?.showAlert?.(m) }catch{ alert(m) } }
function haptic(kind='impact'){ try{ TG?.HapticFeedback?.impactOccurred?.(kind) }catch{}; try{ navigator.vibrate?.(30) }catch{} }
function $(s,r=document){ return r.querySelector(s) }
function $all(s,r=document){ return Array.from(r.querySelectorAll(s)) }
async function api(path, method='GET', body=null){
  const res = await fetch(API_BASE.replace(/\/+$/,'')+path, {
    method, headers: {'Content-Type':'application/json'},
    body: body? JSON.stringify(body): null
  });
  if(!res.ok){
    let msg='HTTP '+res.status; try{ const j = await res.json(); if(j.detail) msg=j.detail }catch{}
    throw new Error(msg);
  }
  const ct = res.headers.get('content-type')||'';
  return ct.includes('application/json') ? res.json() : res.text();
}
function setBusy(btn,on,text){ if(!btn) return; if(!btn.__t) btn.__t=btn.textContent; btn.disabled=!!on; btn.textContent = on?(text||'–ó–∞–≥—Ä—É–∑–∫–∞‚Ä¶'):btn.__t }
function pid(){
  try{ const id = TG?.initDataUnsafe?.user?.id; if(id) return String(id) }catch{}
  let v = localStorage.getItem('NARDY_UID'); if(!v){ v='p_'+Math.random().toString(36).slice(2); localStorage.setItem('NARDY_UID', v) }
  return v;
}
async function refreshBalance(){
  try{ const r=await api('/api/balance?player_id='+encodeURIComponent(pid())); $('#balance').textContent = r.balance }catch{}
}
function renderDonate(){
  const prices = [{coins:50,usd:0.50},{coins:100,usd:0.99},{coins:200,usd:1.99},{coins:500,usd:2.99},{coins:1000,usd:4.99}];
  const box = $('#donateGrid'); box.innerHTML='';
  prices.forEach(p=>{
    const b=document.createElement('button'); b.className='btn secondary';
    b.textContent = `+${p.coins} –º–æ–Ω–µ—Ç ‚Ä¢ $${p.usd.toFixed(2)}`;
    b.onclick = async ()=>{ try{ await api('/api/donate','POST',{player_id:pid(), coins:p.coins}); haptic('heavy'); await refreshBalance(); pop('–°–ø–∞—Å–∏–±–æ! +' + p.coins + ' –º–æ–Ω–µ—Ç') }catch(e){ pop('–û—à–∏–±–∫–∞: '+e.message) } };
    box.appendChild(b);
  });
}

// ===== –ù–∞–≤–∏–≥–∞—Ü–∏—è =====
function showScreen(name){
  $all('.screen').forEach(s=>s.classList.remove('active'));
  $('#screen-'+name)?.classList.add('active');
  $all('.tab').forEach(t=> t.classList.toggle('active', t.dataset.tab===name));
}

// ===== –°–æ—Å—Ç–æ—è–Ω–∏–µ –º–∞—Ç—á–∞ =====
let currentCode=null, myRole=null, myReady=false, lobbyTimer=null;

function renderLobby(players){
  const box = $('#playersBox'); box.innerHTML='';
  ['A','B'].forEach(role=>{
    const p = players?.[role];
    const div = document.createElement('div'); div.className='col card'; div.style.padding='12px';
    if(p){ div.innerHTML = `<strong>${role}</strong><br>${p.name||'–ò–≥—Ä–æ–∫'}<br><span style="color:${p.ready?'#23c552':'#ffcf33'}">${p.ready?'–ì–æ—Ç–æ–≤':'–ù–µ –≥–æ—Ç–æ–≤'}</span>` }
    else { div.innerHTML = `<strong>${role}</strong><br><span class="muted">–û–∂–∏–¥–∞–Ω–∏–µ‚Ä¶</span>` }
    box.appendChild(div);
  });
}

async function pollLobby(){
  clearInterval(lobbyTimer);
  lobbyTimer = setInterval(async ()=>{
    try{
      const st = await api('/api/rooms/'+currentCode+'/status');
      renderLobby(st.players||{});
      const bothReady = !!(st.players?.A?.ready && st.players?.B?.ready);
      $('#btn-start').disabled = !bothReady;
      if(st.game_started){ clearInterval(lobbyTimer); lobbyTimer=null; enterGame() }
    }catch{ clearInterval(lobbyTimer); lobbyTimer=null }
  }, 2000);
}

// ===== –î–µ–π—Å—Ç–≤–∏—è: —Å–æ–∑–¥–∞–Ω–∏–µ/–≤—Ö–æ–¥/–±—ã—Å—Ç—Ä—ã–π –º–∞—Ç—á/–≥–æ—Ç–æ–≤–Ω–æ—Å—Ç—å/—Å—Ç–∞—Ä—Ç/–±—Ä–æ—Å–æ–∫ =====
async function onCreate(){
  const btn=$('#btn-create'); setBusy(btn,true,'–°–æ–∑–¥–∞—ë–º‚Ä¶');
  try{
    const r = await api('/api/rooms/create','POST');
    currentCode=r.code; myRole='A'; myReady=false;
    $('#roomCode').textContent=currentCode; renderLobby({});
    showScreen('lobby'); haptic('rigid'); pop('–ö–æ–¥ –∫–æ–º–Ω–∞—Ç—ã: '+currentCode);
    pollLobby();
  }catch(e){ pop('–ù–µ —É–¥–∞–ª–æ—Å—å —Å–æ–∑–¥–∞—Ç—å: '+e.message) }
  finally{ setBusy(btn,false) }
}

function openJoin(){ $('#join-sheet').classList.add('open') }
function closeJoin(){ $('#join-sheet').classList.remove('open') }

async function onJoinGo(){
  const btn=$('#btn-join-go'); setBusy(btn,true,'–í—Ö–æ–¥–∏–º‚Ä¶');
  try{
    const code = ($('#joinCodeInput').value||'').trim().toUpperCase(); if(!code){ setBusy(btn,false); return pop('–í–≤–µ–¥–∏ –∫–æ–¥ –∫–æ–º–Ω–∞—Ç—ã') }
    const name=$('#profileName')?.value || TG?.initDataUnsafe?.user?.first_name || '–ò–≥—Ä–æ–∫';
    const nick=$('#profileNick')?.value || TG?.initDataUnsafe?.user?.username || '';
    const r = await api('/api/rooms/'+code+'/join','POST',{player_id:pid(), name, nick});
    currentCode=code; myRole=r.role; myReady=false;
    $('#roomCode').textContent=currentCode; closeJoin(); renderLobby({});
    showScreen('lobby'); haptic('soft'); pollLobby();
  }catch(e){ pop('–ù–µ —É–¥–∞–ª–æ—Å—å –≤–æ–π—Ç–∏: '+e.message) }
  finally{ setBusy(btn,false) }
}

let quickTimer=null;
async function onQuick(){
  const btn=$('#btn-quick'); setBusy(btn,true,'–ò—â–µ–º —Å–æ–ø–µ—Ä–Ω–∏–∫–∞‚Ä¶');
  try{
    await api('/api/matchmaking/enqueue','POST',{player_id:pid(), name:($('#profileName')?.value||'–ò–≥—Ä–æ–∫')});
    clearInterval(quickTimer);
    quickTimer = setInterval(async ()=>{
      try{
        const r = await api('/api/matchmaking/poll?player_id='+encodeURIComponent(pid()));
        if(r.found){
          clearInterval(quickTimer); quickTimer=null; haptic('soft');
          currentCode=r.code; myRole=r.role||'B'; $('#roomCode').textContent=currentCode; renderLobby({});
          showScreen('lobby'); setBusy(btn,false); pollLobby();
        }
      }catch{}
    }, 1500);
  }catch(e){ pop('–û—à–∏–±–∫–∞ –±—ã—Å—Ç—Ä–æ–≥–æ –º–∞—Ç—á–∞: '+e.message); setBusy(btn,false) }
}

async function toggleReady(){
  if(!currentCode || !myRole) return pop('–ù–µ—Ç –∫–æ–º–Ω–∞—Ç—ã');
  try{
    const r = await api('/api/rooms/'+currentCode+'/ready','POST',{role:myRole, ready:!myReady});
    myReady=!myReady; renderLobby(r.players||{});
    $('#btn-start').disabled = !(r.players?.A?.ready && r.players?.B?.ready);
    haptic(myReady?'soft':'impact');
  }catch(e){ pop('–ù–µ —É–¥–∞–ª–æ—Å—å: '+e.message) }
}

async function onStart(){
  if(!currentCode) return pop('–ù–µ—Ç –∫–æ–º–Ω–∞—Ç—ã');
  try{
    const st = await api('/api/game/'+currentCode+'/start','POST');
    _gameInit(st.state.board, st.state.turn);
    $('#turnLabel').textContent = st.state.turn==='A'?'–ë–µ–ª—ã–µ (A)':'–ß—ë—Ä–Ω—ã–µ (B)';
    showScreen('game'); haptic('rigid'); clearInterval(lobbyTimer); lobbyTimer=null;
  }catch(e){ pop('–ù–µ–ª—å–∑—è –Ω–∞—á–∞—Ç—å: '+e.message) }
}

async function onRoll(){
  if(!currentCode || !myRole) return pop('–ù–µ—Ç –∞–∫—Ç–∏–≤–Ω–æ–π –∫–æ–º–Ω–∞—Ç—ã');
  try{
    const r = await api('/api/game/'+currentCode+'/roll','POST',{role:myRole});
    _gameDice(r.dice); $('#turnLabel').textContent = r.turn==='A'?'–ë–µ–ª—ã–µ (A)':'–ß—ë—Ä–Ω—ã–µ (B)'; haptic('heavy');
  }catch(e){ pop('–ù–µ–ª—å–∑—è –±—Ä–æ—Å–∏—Ç—å: '+e.message) }
}

// ===== 3D (lazy load) =====
let threeLoaded=false;
function ensureThree(cb){
  if(threeLoaded) return cb();
  const s=document.createElement('script');
  s.src='https://unpkg.com/three@0.158.0/build/three.min.js';
  s.onload=()=>{ threeLoaded=true; cb() };
  s.onerror=()=>{ pop('3D –Ω–µ –∑–∞–≥—Ä—É–∑–∏–ª–æ—Å—å ‚Äî –ø—Ä–æ–¥–æ–ª–∂–∏–º –±–µ–∑ –≤–∏–∑—É–∞–ª–∏–∑–∞—Ü–∏–∏'); cb() };
  document.head.appendChild(s);
}
function enterGame(){
  showScreen('game');
  ensureThree(()=>{
    try{
      if(!window.THREE) return;
      const canvas=$('#gameCanvas');
      const scene=new THREE.Scene();
      const renderer=new THREE.WebGLRenderer({canvas, antialias:true, alpha:true});
      const camera=new THREE.PerspectiveCamera(40, canvas.clientWidth/canvas.clientHeight, 0.1, 100);
      camera.position.set(0,7,9); camera.lookAt(0,0,0);
      scene.add(new THREE.AmbientLight(0xffffff,.45));
      const dl=new THREE.DirectionalLight(0xffffff,1.0); dl.position.set(5,10,7); scene.add(dl);
      const board=new THREE.Mesh(new THREE.BoxGeometry(10,0.4,6), new THREE.MeshStandardMaterial({color:0x3a2a21, roughness:.8, metalness:.1}));
      board.position.y=-0.2; scene.add(board);

      const checkerGeo=new THREE.CylinderGeometry(0.25,0.25,0.12,32);
      const matA=new THREE.MeshStandardMaterial({color:0xf2f2f2, metalness:.2, roughness:.6});
      const matB=new THREE.MeshStandardMaterial({color:0x111418, metalness:.2, roughness:.6});
      const checkers=[]; let boardArr=Array(24).fill(0);

      function pointToXY(i){ const w=4.4,h=2.2,g=0.4; if(i<=11){ const idx=11-i; return [-w+(idx%6)*((2*w-g)/5), -h] } const idx=i-12; return [-w+(idx%6)*((2*w-g)/5), h] }
      function rebuild(){
        checkers.forEach(m=>scene.remove(m)); checkers.length=0;
        for(let i=0;i<24;i++){ const n=Math.abs(boardArr[i]), a=boardArr[i]>0; for(let s=0;s<n;s++){ const m=new THREE.Mesh(checkerGeo,a?matA:matB); const [x,z]=pointToXY(i); m.position.set(x,(s*0.13)+0.06,z); scene.add(m); checkers.push(m) } }
        render();
      }
      function render(){ renderer.setSize(canvas.clientWidth, canvas.clientHeight, false); renderer.render(scene,camera) }

      window._gameInit = (arr, turn)=>{ boardArr = arr.slice(); rebuild(); $('#turnLabel').textContent = turn==='A'?'–ë–µ–ª—ã–µ (A)':'–ß—ë—Ä–Ω—ã–µ (B)' }
      window._gameDice = (vals)=>{
        if(!vals?.length) return;
        const dice=[]; const make=()=>new THREE.Mesh(new THREE.BoxGeometry(0.5,0.5,0.5), new THREE.MeshStandardMaterial({color:0xffffff, roughness:.5, metalness:.2}));
        for(let i=0;i<Math.min(2,vals.length);i++){ const d=make(); d.position.set(-2+i*1.0,-1.5,3.2); scene.add(d); dice.push(d) }
        const t0=performance.now(); (function tick(){ const t=(performance.now()-t0)/1000; dice.forEach((d,i)=>{ d.position.y=Math.min(0.6,-1.5+t*2.5); d.position.x+=0.01+i*0.005; d.rotation.x+=0.2+i*0.1; d.rotation.y+=0.3 }); render(); if(t<1.0) requestAnimationFrame(tick) })();
      };
      render();
    }catch(e){ console.error(e); pop('3D –æ—à–∏–±–∫–∞: '+e.message) }
  });
}
function _gameInit(){/* –∑–∞–≥–ª—É—à–∫–∞ –∑–∞–º–µ–Ω–∏—Ç—Å—è –≤ enterGame */}
function _gameDice(){/* –∑–∞–≥–ª—É—à–∫–∞ –∑–∞–º–µ–Ω–∏—Ç—Å—è –≤ enterGame */}

window.addEventListener('DOMContentLoaded', async ()=>{
  pop('Frontend v24 loaded'); // –≥–∞—Ä–∞–Ω—Ç–∏—è, —á—Ç–æ —Å–∫—Ä–∏–ø—Ç —Ä–µ–∞–ª—å–Ω–æ –∑–∞–ø—É—Å—Ç–∏–ª—Å—è
  renderDonate(); refreshBalance();
  // –ª—ë–≥–∫–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞ API
  fetch(API_BASE.replace(/\/+$/,'')+'/health').then(r=>r.text()).then(t=>{ if((t||'').trim()!=='ok') pop('API /health –Ω–µ ok: '+t) }).catch(()=> pop('API –Ω–µ –¥–æ—Å—Ç—É–ø–Ω–æ. –ü—Ä–æ–≤–µ—Ä—å API_BASE.'));
});
</script>
</body>
</html>
